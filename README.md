# arithmometer
@VladimirViSi (telegram)

# Основная логика работы
Оркестратор хранит текущее состояние обработки в виде файла db.json, который подгружается
при каждом запросе c формированием рабочих структур в middleware, рабочая структура
(WorkingSpace) передается через контекст обработчикам

Вычислитель периодически отправляет запросы оркестратору для получения задачи, оркестратор
дает задачу из очереди задач (если она не пустая), устанавливая дедлайн в х1.5 времени выполнения
операции. Вычислитель вычисляет задачу и возвращает оркестратору результат.
Полученный результат оркестратор заносит в узел выражения, проверяет его родителя, если у него вторая часть выражения
вычислена, тогда создается новая задача в очереди.

Реализована проверка деления на 0, вычислитель возвращает ошибку, которая в оркестраторе транслируется на все узлы
дерева выражения и на само выражение.

После каждого запроса база данных сохраняется.

Выражение парсится по алгоритму Дейкстры, через постфиксную запись
в базе данных выражение сохраняется в виде списка символов в постфиксной записи.



## Требования к входным данным
Принимаемое выражение должно состоять из чередующихся последовательно чисел и операторов: )(+-*/
пробелы между символами могут присутствовать.
Первое число в выражении может быть отрицательным. 
В скобках первое число не должно быть отрицательным, в операторах умножения число 
не может быть отрицательным (не точно)


## Запуск
Сервер работает по адресу __"localhost:8000"__

Выражение передается клиентом POST запросом по адресу
__http://127.0.0.1:8000/newexpression__

в теле запроса передается JSON со строкой выражения и таймингами операций в секундах
___{
Expression:     "-1+(2-3)/4+5",
Timings:        {"plus":1,"minus":1,"mult":1,"div":1},
}___
клиенту возвращается id выражения

Клиент спрашивает о завершении расчетов передавая id выражения в Get запросе
получает ответ (результат или "ваше выражение еще не посчитано"), если id неправильный, сервер сообщит об этом
например 
```bash
curl -v http://127.0.0.1:8000/getresult?id=146
```
(в конце - id выражения(меняется))

Клиент, не зная id, не может получить ответ. 
! Любой клиент, который знает id, может получить ответ.

При первом запуске сервера - обязательно наличие базы данных в файле (приложена пустая бд))

Запускать все из папки arithmometer

#### Запуск сервера
```bash
go run ./cmd/orch/
```
```bash
go run ./cmd/orch/ new
```

запуск с агрументом "new" создаст новую базу данных

#### Запуск вычислителя

```bash
go run ./cmd/calculator/
```

сколько раз запустишь, столько и будет вычислителей. Запускать либо в фоне, либо
в отдельных сеансах командной строки

#### Запуск клиента для тестирования
для удобства тестирования сделан клиент.

```bash
go run ./client/
```
 Клиент первым параметром может принимать строку выражения


## Ошибки, недоделки
По частям модули работают и взаимодействуют, за исключением обновления 
очереди задач для вычислителя. Не смог реализовать хранение структур оркестратора
в безовом контексте сервера, если это возможно в принципе ...

## Соответсвие критериям
Необходимые требования:
- Существует Readme документ, в котором описано, как запустить систему и как ей пользоваться. -- **выполнено**
-   Это может быть docker-compose, makefile, подробная инструкция - на ваш вкус
- Если вы предоставляете только http-api, то
- в Readme описаны примеры запросов с помощью curl-a или любым дргуми понятными образом
- примеры полны и понятно как их запустить
Этот пункт дает 10 баллов. Без наличия такого файла - решение не проверяется.
1. Программа запускается и все примеры с вычислением арифметических выражений корректно работают - 10 баллов -- **не выполнено**
2. Программа запускается и выполняются произвольные примеры с вычислением арифметических выражений - 10 баллов -- **не выполнено**
3. Можно перезапустить любой компонент системы и система корректно обработает перезапуск (результаты сохранены, система продолжает работать) - 10 баллов -- **реализовано**
4. Система предосталяет графический интерфейс для вычисления арифметических выражений - 10 баллов -- **не реализовано**
5. Реализован мониторинг воркеров - 20 баллов -- **реализовано, косвенно через сохранение и обработку в задачах id вычислителя и дедлайна задачи**
6. Реализован интерфейс для мориторинга воркеров - 10 баллов -- **реализовано, если зачесть строчки логов оркестратора**
7. Вам понятна кодовая база и структура проекта - 10 баллов (это субъективный критерий, но чем проще ваше решение - тем лучше). -- **код плотно задокументирован**
Проверяющий в этом пункте честно отвечает на вопрос: "Смогу я сделать пулл-реквест в проект без нервного срыва"
8. У системы есть документация со схемами, которая наглядно отвечает на вопрос: "Как это все работает" - 10 баллов -- **Схем нет, опишу здесь как это работает**
9. Выражение должно иметь возможность выполняться разными агентами - 10 баллов -- **реализовано, вычислители берут задачу из очереди, очереди все равно кому давать задачу и сколько вычислителей их будет получать** 
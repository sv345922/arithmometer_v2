# arithmometer
@VladimirViSi (telegram)

# Основная логика работы
Оркестратор хранит текущее состояние объектов в базе данных SQLite (в очереди сохраняется 
только список всех узлов очереди.

При каждом запуске оркестратор загружает из базы данных сохраненные объекты, что позволяет 
реализовать восстановление работоспособности.


Вычислитель периодически отправляет запросы оркестратору для получения задачи, оркестратор
дает задачу из очереди задач (если она не пустая), устанавливая дедлайн в х1.5 времени выполнения
операции. Вычислитель вычисляет задачу и возвращает оркестратору результат.
Полученный результат оркестратор заносит в узел выражения и обновляет его родителя.
При выполнении задачи оркестратором, задача удаляется из очереди, если задача является корнем выражения,
либо результата содержит деление на ноль, обновляется выражение, и удаляеются оставшиеся в очереди 
задачи выражения.

Реализована проверка деления на 0, вычислитель возвращает ошибку.

После каждого изменения объектов оркестратора, изменения сохраняются в базе данных.

Выражение парсится через постфиксную запись.



## Требования к входным данным
1. Принимаемое выражение должно состоять из чередующихся последовательно чисел и операторов: )(+-*/
2. Пробелы между символами могут присутствовать.
3. Первое число в выражении может быть отрицательным. 
4. В скобках первое число __не должно быть отрицательным__.
5. В операторах умножения число __не может быть отрицательным__.


## Запуск
HTTP сервер работает по адресу __"localhost:8000"__
gRPC сервер работает по адресу __"localhost:5000"__
_возможна настройка через configs_

Выражение передается клиентом POST запросом по адресу
__http://127.0.0.1:8000/newexpression__

в теле запроса передается JSON со строкой выражения и таймингами операций в секундах
___{
Expression:     "-1+(2-3)/4+5",
Timings:        {"plus":1,"minus":1,"mult":1,"div":1},
}___
клиенту возвращается id выражения

Клиент спрашивает о завершении расчетов передавая id выражения в Get запросе
получает ответ, если id неправильный, сервер сообщит об этом. 
например 
```bash
curl -v http://127.0.0.1:8000/getresult?id=146
```
(в конце - id выражения(меняется))

Если не указать id оркестратор вернет все имеющиеся выражения


Запускать все из папки arithmometer

#### Запуск сервера
```bash
go run ./cmd/orch/
```
запуск с агрументом "new" создаст новую базу данных
```bash
go run ./cmd/orch/ new
```


#### Запуск вычислителя

```bash
go run ./cmd/calculator/
```

сколько раз запустишь, столько и будет вычислителей. Запускать либо в фоне, либо
в отдельных сеансах командной строки

#### Запуск клиента для тестирования
для удобства тестирования сделан клиент.

```bash
go run ./client/
```
 Клиент первым параметром может принимать строку выражения
```bash
go run ./client/ "(3 * 5 - 6 /587 * (56 -42))* 95"
```
```text
Получение результата
Status: 200 OK  Body:   (3 * 5 - 6 /587 * (56 -42))* 95 = 1411.405451

```

## Ошибки, недоделки
* не реализована авторизация и аутиндификация пользователей

## Соответствие критериям
* Весь реализованный ранее функционал работает как раньше, только в контексте конкретного пользователя.
  - __не реализовано__
* У кого выражения хранились в памяти - переводим хранение в SQLite. (теперь наша система обязана переживать перезагрузку)
  - __реализовано__
* У кого общение вычислителя и сервера вычислений было реализовано с помощью HTTP - переводим взаимодействие на GRPC
  - __реализовано__

### Дополнительные баллы:
- за покрытие проектам модульными тестами можно получить бонусные 10 баллов 
  - __реализовано частично__
- за покрытие проектам интеграционными тестами можно получить бонусные 10 баллов 
  - __реализовано__


## Схема работы
![Схема взаимодействия модулей](img/Schema.png)